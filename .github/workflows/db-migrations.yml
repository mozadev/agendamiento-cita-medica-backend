name: Database Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migrations'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      migration_action:
        description: 'Migration action'
        required: true
        type: choice
        default: 'apply'
        options:
          - apply    # Apply pending migrations
          - verify   # Only verify connection and status
          - force    # Force re-apply all migrations (dangerous)

env:
  AWS_REGION: us-east-1

jobs:
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install MySQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client jq

      - name: Get RDS Endpoints from Secrets Manager
        id: get-endpoints
        run: |
          ENV="${{ github.event.inputs.environment }}"
          PROJECT_NAME="agendamiento-v2"
          
          echo "ğŸ“¡ Obteniendo endpoints de RDS desde Secrets Manager..."
          
          # Obtener secret de Peru
          PERU_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id "${PROJECT_NAME}-${ENV}-rds-peru-credentials" \
            --region ${{ env.AWS_REGION }} \
            --query SecretString \
            --output text)
          
          # Obtener secret de Chile
          CHILE_SECRET=$(aws secretsmanager get-secret-value \
            --secret-id "${PROJECT_NAME}-${ENV}-rds-chile-credentials" \
            --region ${{ env.AWS_REGION }} \
            --query SecretString \
            --output text)
          
          # Extraer valores
          PERU_HOST=$(echo "$PERU_SECRET" | jq -r '.host')
          PERU_USERNAME=$(echo "$PERU_SECRET" | jq -r '.username')
          PERU_PASSWORD=$(echo "$PERU_SECRET" | jq -r '.password')
          PERU_DBNAME=$(echo "$PERU_SECRET" | jq -r '.dbname')
          
          CHILE_HOST=$(echo "$CHILE_SECRET" | jq -r '.host')
          CHILE_USERNAME=$(echo "$CHILE_SECRET" | jq -r '.username')
          CHILE_PASSWORD=$(echo "$CHILE_SECRET" | jq -r '.password')
          CHILE_DBNAME=$(echo "$CHILE_SECRET" | jq -r '.dbname')
          
          # Guardar en outputs (masked)
          echo "::add-mask::$PERU_PASSWORD"
          echo "::add-mask::$CHILE_PASSWORD"
          
          echo "peru_host=$PERU_HOST" >> $GITHUB_OUTPUT
          echo "peru_username=$PERU_USERNAME" >> $GITHUB_OUTPUT
          echo "peru_password=$PERU_PASSWORD" >> $GITHUB_OUTPUT
          echo "peru_dbname=$PERU_DBNAME" >> $GITHUB_OUTPUT
          
          echo "chile_host=$CHILE_HOST" >> $GITHUB_OUTPUT
          echo "chile_username=$CHILE_USERNAME" >> $GITHUB_OUTPUT
          echo "chile_password=$CHILE_PASSWORD" >> $GITHUB_OUTPUT
          echo "chile_dbname=$CHILE_DBNAME" >> $GITHUB_OUTPUT
          
          echo "âœ… Endpoints obtenidos correctamente"
          echo "  Peru:  $PERU_HOST"
          echo "  Chile: $CHILE_HOST"

      - name: Wait for RDS Instances to Accept Connections
        run: |
          echo "â³ Esperando a que las instancias RDS acepten conexiones..."
          
          PERU_HOST="${{ steps.get-endpoints.outputs.peru_host }}"
          CHILE_HOST="${{ steps.get-endpoints.outputs.chile_host }}"
          
          for DB_HOST in "$PERU_HOST" "$CHILE_HOST"; do
            echo "ğŸ” Verificando conectividad a $DB_HOST..."
            MAX_ATTEMPTS=20
            ATTEMPT=0
            
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              if timeout 5 bash -c "cat < /dev/null > /dev/tcp/${DB_HOST}/3306" 2>/dev/null; then
                echo "âœ… ConexiÃ³n exitosa a $DB_HOST"
                break
              else
                echo "  â³ Intento $((ATTEMPT + 1))/$MAX_ATTEMPTS - Esperando 15 segundos..."
                sleep 15
                ATTEMPT=$((ATTEMPT + 1))
              fi
            done
            
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "âŒ No se pudo conectar a $DB_HOST despuÃ©s de $MAX_ATTEMPTS intentos"
              exit 1
            fi
          done
          
          echo "âœ… Todas las instancias RDS estÃ¡n aceptando conexiones"

      - name: Verify Migration Action
        run: |
          ACTION="${{ github.event.inputs.migration_action }}"
          ENV="${{ github.event.inputs.environment }}"
          
          echo "ğŸ¯ AcciÃ³n de migraciÃ³n: $ACTION"
          echo "ğŸŒ Ambiente: $ENV"
          
          if [ "$ACTION" == "force" ] && [ "$ENV" == "prod" ]; then
            echo "âš ï¸  ADVERTENCIA: Force migration en producciÃ³n requiere confirmaciÃ³n adicional"
            echo "   Esta operaciÃ³n es potencialmente destructiva"
            # En producciÃ³n real, aquÃ­ se podrÃ­a requerir aprobaciÃ³n manual
          fi

      - name: Check Migration Status - Peru
        id: check-peru
        continue-on-error: true
        run: |
          PERU_HOST="${{ steps.get-endpoints.outputs.peru_host }}"
          PERU_USER="${{ steps.get-endpoints.outputs.peru_username }}"
          PERU_PASS="${{ steps.get-endpoints.outputs.peru_password }}"
          PERU_DB="${{ steps.get-endpoints.outputs.peru_dbname }}"
          
          echo "ğŸ” Verificando estado de la base de datos Peru..."
          
          # Verificar si la tabla 'appointments' existe
          TABLE_EXISTS=$(mysql -h "$PERU_HOST" -u "$PERU_USER" -p"$PERU_PASS" "$PERU_DB" \
            -sN -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='$PERU_DB' AND table_name='appointments';" \
            2>/dev/null || echo "0")
          
          if [ "$TABLE_EXISTS" == "1" ]; then
            echo "âœ… Tabla 'appointments' ya existe en Peru DB"
            echo "needs_migration=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ Tabla 'appointments' NO existe en Peru DB - Se requiere migraciÃ³n"
            echo "needs_migration=true" >> $GITHUB_OUTPUT
          fi

      - name: Check Migration Status - Chile
        id: check-chile
        continue-on-error: true
        run: |
          CHILE_HOST="${{ steps.get-endpoints.outputs.chile_host }}"
          CHILE_USER="${{ steps.get-endpoints.outputs.chile_username }}"
          CHILE_PASS="${{ steps.get-endpoints.outputs.chile_password }}"
          CHILE_DB="${{ steps.get-endpoints.outputs.chile_dbname }}"
          
          echo "ğŸ” Verificando estado de la base de datos Chile..."
          
          # Verificar si la tabla 'appointments' existe
          TABLE_EXISTS=$(mysql -h "$CHILE_HOST" -u "$CHILE_USER" -p"$CHILE_PASS" "$CHILE_DB" \
            -sN -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='$CHILE_DB' AND table_name='appointments';" \
            2>/dev/null || echo "0")
          
          if [ "$TABLE_EXISTS" == "1" ]; then
            echo "âœ… Tabla 'appointments' ya existe en Chile DB"
            echo "needs_migration=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ Tabla 'appointments' NO existe en Chile DB - Se requiere migraciÃ³n"
            echo "needs_migration=true" >> $GITHUB_OUTPUT
          fi

      - name: Apply Migration - Peru
        if: |
          github.event.inputs.migration_action != 'verify' &&
          (steps.check-peru.outputs.needs_migration == 'true' || github.event.inputs.migration_action == 'force')
        run: |
          PERU_HOST="${{ steps.get-endpoints.outputs.peru_host }}"
          PERU_USER="${{ steps.get-endpoints.outputs.peru_username }}"
          PERU_PASS="${{ steps.get-endpoints.outputs.peru_password }}"
          PERU_DB="${{ steps.get-endpoints.outputs.peru_dbname }}"
          
          echo "ğŸš€ Aplicando migraciÃ³n a Peru DB..."
          
          if mysql -h "$PERU_HOST" -u "$PERU_USER" -p"$PERU_PASS" "$PERU_DB" \
            < docs/database-schema.sql; then
            echo "âœ… MigraciÃ³n aplicada exitosamente a Peru DB"
          else
            echo "âŒ Error aplicando migraciÃ³n a Peru DB"
            exit 1
          fi

      - name: Apply Migration - Chile
        if: |
          github.event.inputs.migration_action != 'verify' &&
          (steps.check-chile.outputs.needs_migration == 'true' || github.event.inputs.migration_action == 'force')
        run: |
          CHILE_HOST="${{ steps.get-endpoints.outputs.chile_host }}"
          CHILE_USER="${{ steps.get-endpoints.outputs.chile_username }}"
          CHILE_PASS="${{ steps.get-endpoints.outputs.chile_password }}"
          CHILE_DB="${{ steps.get-endpoints.outputs.chile_dbname }}"
          
          echo "ğŸš€ Aplicando migraciÃ³n a Chile DB..."
          
          if mysql -h "$CHILE_HOST" -u "$CHILE_USER" -p"$CHILE_PASS" "$CHILE_DB" \
            < docs/database-schema.sql; then
            echo "âœ… MigraciÃ³n aplicada exitosamente a Chile DB"
          else
            echo "âŒ Error aplicando migraciÃ³n a Chile DB"
            exit 1
          fi

      - name: Verify Migration - Peru
        run: |
          PERU_HOST="${{ steps.get-endpoints.outputs.peru_host }}"
          PERU_USER="${{ steps.get-endpoints.outputs.peru_username }}"
          PERU_PASS="${{ steps.get-endpoints.outputs.peru_password }}"
          PERU_DB="${{ steps.get-endpoints.outputs.peru_dbname }}"
          
          echo "âœ”ï¸  Verificando migraciÃ³n en Peru DB..."
          
          # Verificar que las tablas existen
          TABLES=$(mysql -h "$PERU_HOST" -u "$PERU_USER" -p"$PERU_PASS" "$PERU_DB" \
            -sN -e "SHOW TABLES;" 2>/dev/null)
          
          if [ -z "$TABLES" ]; then
            echo "âš ï¸  No se encontraron tablas en Peru DB"
          else
            echo "âœ… Tablas en Peru DB:"
            echo "$TABLES" | sed 's/^/   - /'
          fi

      - name: Verify Migration - Chile
        run: |
          CHILE_HOST="${{ steps.get-endpoints.outputs.chile_host }}"
          CHILE_USER="${{ steps.get-endpoints.outputs.chile_username }}"
          CHILE_PASS="${{ steps.get-endpoints.outputs.chile_password }}"
          CHILE_DB="${{ steps.get-endpoints.outputs.chile_dbname }}"
          
          echo "âœ”ï¸  Verificando migraciÃ³n en Chile DB..."
          
          # Verificar que las tablas existen
          TABLES=$(mysql -h "$CHILE_HOST" -u "$CHILE_USER" -p"$CHILE_PASS" "$CHILE_DB" \
            -sN -e "SHOW TABLES;" 2>/dev/null)
          
          if [ -z "$TABLES" ]; then
            echo "âš ï¸  No se encontraron tablas en Chile DB"
          else
            echo "âœ… Tablas en Chile DB:"
            echo "$TABLES" | sed 's/^/   - /'
          fi

      - name: Migration Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESUMEN DE MIGRACIÃ“N"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Ambiente: ${{ github.event.inputs.environment }}"
          echo "AcciÃ³n:   ${{ github.event.inputs.migration_action }}"
          echo ""
          echo "Peru DB:  ${{ steps.check-peru.outputs.needs_migration == 'true' && 'âœ… Migrado' || 'â­ï¸  Ya actualizado' }}"
          echo "Chile DB: ${{ steps.check-chile.outputs.needs_migration == 'true' && 'âœ… Migrado' || 'â­ï¸  Ya actualizado' }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

