name: Database Migrations

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migrations'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      migration_action:
        description: 'Migration action'
        required: true
        type: choice
        default: 'apply'
        options:
          - apply    # Apply pending migrations
          - verify   # Only verify connection and status
          - force    # Force re-apply all migrations (dangerous)

env:
  AWS_REGION: us-east-1

jobs:
  run-migrations:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Lambda Function Name
        id: get-lambda
        run: |
          ENV="${{ github.event.inputs.environment }}"
          # El nombre de la funciÃ³n en SAM es: ${Environment}-db-migration
          FUNCTION_NAME="${ENV}-db-migration"
          echo "function_name=$FUNCTION_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ” Buscando Lambda function: $FUNCTION_NAME"
          
          # Verificar que la funciÃ³n existe
          if aws lambda get-function --function-name "$FUNCTION_NAME" --region ${{ env.AWS_REGION }} >/dev/null 2>&1; then
            echo "âœ… Lambda function encontrada: $FUNCTION_NAME"
          else
            echo "âŒ Lambda function no encontrada: $FUNCTION_NAME"
            echo ""
            echo "ğŸ” Listando funciones Lambda disponibles..."
            aws lambda list-functions \
              --region ${{ env.AWS_REGION }} \
              --query 'Functions[?contains(FunctionName, `db-migration`) || contains(FunctionName, `migration`)].FunctionName' \
              --output table || echo "No se pudieron listar funciones"
            echo ""
            echo "ğŸ’¡ AsegÃºrate de que el deploy de SAM se haya completado exitosamente"
            exit 1
          fi

      - name: Verify Migration Action
        run: |
          ACTION="${{ github.event.inputs.migration_action }}"
          ENV="${{ github.event.inputs.environment }}"
          
          echo "ğŸ¯ AcciÃ³n de migraciÃ³n: $ACTION"
          echo "ğŸŒ Ambiente: $ENV"
          
          if [ "$ACTION" == "force" ] && [ "$ENV" == "prod" ]; then
            echo "âš ï¸  ADVERTENCIA: Force migration en producciÃ³n requiere confirmaciÃ³n adicional"
            echo "   Esta operaciÃ³n es potencialmente destructiva"
          fi

      - name: Invoke Database Migration Lambda
        id: invoke-migration
        timeout-minutes: 20
        run: |
          FUNCTION_NAME="${{ steps.get-lambda.outputs.function_name }}"
          ACTION="${{ github.event.inputs.migration_action }}"
          
          echo "ğŸš€ Invocando Lambda function: $FUNCTION_NAME"
          echo "ğŸ“ AcciÃ³n: $ACTION"
          echo ""
          
          # Preparar payload para Lambda
          PAYLOAD=$(cat <<EOF
          {
            "action": "$ACTION",
            "country": "both"
          }
          EOF
          )
          
          echo "ğŸ“¤ Invocando funciÃ³n..."
          echo "ğŸ“‹ Payload:"
          echo "$PAYLOAD" | jq '.' || echo "$PAYLOAD"
          echo ""
          
          # Invocar Lambda y capturar tanto stdout como stderr
          set +e  # No salir inmediatamente en error
          aws lambda invoke \
            --function-name "$FUNCTION_NAME" \
            --payload "$PAYLOAD" \
            --region ${{ env.AWS_REGION }} \
            --cli-read-timeout 900 \
            /tmp/lambda-response.json > /tmp/lambda-invoke-output.json 2>&1
          
          EXIT_CODE=$?
          set -e  # Reactivar salir en error
          
          # Mostrar output de AWS CLI
          if [ -f /tmp/lambda-invoke-output.json ]; then
            echo "ğŸ“‹ AWS CLI Output:"
            cat /tmp/lambda-invoke-output.json
            echo ""
          fi
          
          # Leer respuesta (incluso si hubo error, puede contener informaciÃ³n Ãºtil)
          RESPONSE_BODY=""
          if [ -f /tmp/lambda-response.json ]; then
            RESPONSE_BODY=$(cat /tmp/lambda-response.json)
            echo "ğŸ“¥ Respuesta de Lambda:"
            echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
            echo ""
            
            # Verificar si hubo error en la respuesta
            ERROR=$(echo "$RESPONSE_BODY" | jq -r '.errorMessage // empty' 2>/dev/null || echo "")
            ERROR_TYPE=$(echo "$RESPONSE_BODY" | jq -r '.errorType // empty' 2>/dev/null || echo "")
            
            if [ ! -z "$ERROR" ]; then
              echo "âŒ Error en Lambda:"
              echo "   Tipo: $ERROR_TYPE"
              echo "   Mensaje: $ERROR"
              echo ""
              echo "ğŸ“‹ Stack trace:"
              echo "$RESPONSE_BODY" | jq -r '.stackTrace // empty' 2>/dev/null || echo "No stack trace disponible"
              exit 1
            fi
          fi
          
          # Si el comando AWS CLI fallÃ³, mostrar error
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ Error invocando Lambda (exit code: $EXIT_CODE)"
            if [ -f /tmp/lambda-invoke-output.json ]; then
              echo "ğŸ“‹ Detalles del error:"
              cat /tmp/lambda-invoke-output.json
            fi
            if [ -z "$RESPONSE_BODY" ]; then
              echo "âš ï¸  No se recibiÃ³ respuesta de Lambda"
            fi
            exit 1
          fi
          
          # Extraer resultados (solo si no hubo error y hay respuesta)
          if [ ! -z "$RESPONSE_BODY" ]; then
            PERU_RESULT=$(echo "$RESPONSE_BODY" | jq -r '.body | fromjson | .results.peru // empty' 2>/dev/null || echo "")
            CHILE_RESULT=$(echo "$RESPONSE_BODY" | jq -r '.body | fromjson | .results.chile // empty' 2>/dev/null || echo "")
            
            if [ ! -z "$PERU_RESULT" ]; then
              echo ""
              echo "ğŸ“Š Resultado PerÃº:"
              echo "$PERU_RESULT" | jq '.' 2>/dev/null || echo "$PERU_RESULT"
            fi
            
            if [ ! -z "$CHILE_RESULT" ]; then
              echo ""
              echo "ğŸ“Š Resultado Chile:"
              echo "$CHILE_RESULT" | jq '.' 2>/dev/null || echo "$CHILE_RESULT"
            fi
            
            if [ -z "$PERU_RESULT" ] && [ -z "$CHILE_RESULT" ]; then
              echo "âš ï¸  No se pudieron extraer resultados de la respuesta"
            fi
          fi
          
          echo ""
          echo "âœ… MigraciÃ³n completada"

      - name: Migration Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RESUMEN DE MIGRACIÃ“N"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Ambiente: ${{ github.event.inputs.environment }}"
          echo "AcciÃ³n:   ${{ github.event.inputs.migration_action }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

